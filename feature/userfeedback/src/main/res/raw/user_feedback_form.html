<!DOCTYPE html>
<html lang="en">
    <head>
        <script
                id="ze-snippet"
                src="https://static.zdassets.com/ekr/snippet.js?key=8ded7c6f-5e21-423d-bd23-75d1a3dfc46c"></script>
        <title>Crisis Cleanup Feedback</title>
    </head>
    <script>
    const openLauncher = () => {
        const launcher = document.getElementById("launcher")
        if (launcher) {
            const buttons = launcher.contentDocument.getElementsByTagName("button")
            if (buttons) {
                var launcherButton = buttons[0]
                Array.from(buttons).forEach(button => {
                    if (button.dataset.testid == "launcher") {
                        launcherButton = button
                    }
                })
                launcherButton.click()
            }
            return true
        }
        return false
    }

    let formWaitCounter = 0
    const autofillData = () => {
        const fieldsData = [
            { key: 'ccid', id: '16781124470797' },
            { key: 'appType', id: '17191842436621' },
        ]
        const autofillField = ({key, id, element}) => {
            const parent = element.parentNode
            switch(key) {
                case 'ccid':
                    const ccidSelector = `input[name='key:${id}']`
                    const ccidElement = parent.querySelector(ccidSelector)
                    if (ccidElement) {
                        // TODO Set actual ID
                        ccidElement.value = "0"
                        parent?.style?.setProperty('display', 'none')
                    }
                    break
                case 'appType':
                    const appTypeSelector = `div[data-garden-id='dropdowns.select']`
                    const appTypeElement = parent.querySelector(appTypeSelector)
                    const appTypeInputSelector = `input[data-garden-id='dropdowns.input']`
                    const appTypeInput = parent.querySelector(appTypeInputSelector)
                    if (appTypeElement && appTypeInput) {
                        appTypeElement.textContent = "Android"
                        appTypeInput.value = "android"
                        parent?.style?.setProperty('display', 'none')
                    }
                    break
            }
        }
        const waitForForm = () => {
            const iFrames = document.getElementsByTagName("iframe")
            for (const iFrame of Array.from(iFrames)) {
                const targetFields = fieldsData.map( ({ key, id }) => {
                    const selector = `label[data-fieldid='key:${id}']`
                    const element = iFrame.contentDocument.body.querySelector(selector)
                    return element ? { key, id, element } : null
                })
                .filter(f => f)

                Array.from(targetFields).forEach(input => {
                    autofillField(input)
                })

                if (targetFields.length == fieldsData.length) {
                    return
                }
            }

            if (formWaitCounter++ < 20) {
                setTimeout(waitForForm, 100)
            }
        }
        waitForForm()
    }

    let waitCounter = 0
    const waitForLauncher = () => {
        if (openLauncher()) {
            autofillData()
            return
        }

        if (waitCounter++ > 10) {
            return
        }

        console.log("Waiting for feedback content to load", waitCounter)
        setTimeout(waitForLauncher, 1000)
    }

    waitForLauncher()

    </script>
</html>